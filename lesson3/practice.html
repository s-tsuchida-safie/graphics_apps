<html>

<style>
canvas {
  border: 1px solid #000;
}
</style>

<script>
  const CANVAS_WIDTH = 1000
  const CANVAS_HEIGHT = 600

  const MARGIN_TOP = 60
  const MARGIN_RIGHT = 30
  const MARGIN_LEFT = 80
  const MARGIN_BOTTOM = 60

  const FRAME_WIDTH = CANVAS_WIDTH - MARGIN_LEFT - MARGIN_RIGHT
  const FRAME_HEIGHT = CANVAS_HEIGHT - MARGIN_TOP - MARGIN_BOTTOM

  const CHART_BAR_WIDTH = 50

  const CATEGORY_COLOR = {
    "国家機関費": "#c20",
    "地方財政費": "#385",
    "防衛関係費": "#527dbfff",
    "国土保全及び開発費": "#52bf8dff",
    "産業経済費": "#bf526fff",
    "教育文化費": "#52bf96ff",
    "社会保障関係費": "#46a",
    "恩給費": "#f8ff00cc",
    "国債費": "#bf5252ff",
    "その他": "#97bf52ff",
  }

  const Y_UNIT_LIST = [{
    unit: '兆',
    value: 1000000000
  }, {
    unit: '億',
    value: 1000000
  }]

  let offsetX = 0
  let scaleX = 1
  let mouseDown = false
  let mousePosX = 0
  let currentChartData = []
  
  const getYLimit = (data) => {
    return 180000000000
  }

  const getYGridCount = () => {
    return 6
  }

  const getBarHeight = (amount) => {
    return amount / getYLimit() * FRAME_HEIGHT
  }

  const getBarWidth = (dataSize) => {
    return FRAME_WIDTH * scaleX / dataSize
  }

  const xToCancasX = (x) => {
    return scaleX * (x + offsetX)
  }

  const canvasXToX = (canvasX) => {
    return canvasX / scaleX - offsetX
  }

  const canvasYToY = (canvasY) => {
    return (FRAME_HEIGHT - canvasY + MARGIN_TOP) / FRAME_HEIGHT * getYLimit()
  }

  const yToCanvasY = (y) => {
    return FRAME_HEIGHT - y / getYLimit() * FRAME_HEIGHT + MARGIN_TOP
  }

  const getYWithUnitText = (y) => {
    let tempY = y
    let text = ''
    for (const yUnit of Y_UNIT_LIST) {
      const y = Math.floor(tempY / yUnit.value)
      if (y > 0) {
        text += y + yUnit.unit
        tempY -= y * yUnit.value
      }
    }
    return text
  }

  const drawBarChart = (data) => {
    const canvas = document.getElementById('barChart')
    const ctx = canvas.getContext('2d')

    // グラフのフレームを描画
    ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT)
    ctx.beginPath()
    ctx.rect(MARGIN_LEFT, MARGIN_TOP, FRAME_WIDTH, FRAME_HEIGHT)
    ctx.stroke()

    // y軸のグリッドを描画
    const yGridCount = getYGridCount()
    const yLimit = getYLimit()
    for (let i = 1; i <= yGridCount; i++) {
      const canvasX = MARGIN_LEFT
      const y = i * yLimit / yGridCount
      const canvasY = yToCanvasY(y)
      ctx.beginPath()
      ctx.moveTo(canvasX, canvasY)
      ctx.lineTo(canvasX + FRAME_WIDTH, canvasY)
      ctx.stroke()
    }

    // 積み上げ棒グラフを描画
    for (let i = 0; i < data.length; i++) {
      const barHeight = getBarHeight(data[i]['合計'])
      const x = CHART_BAR_WIDTH * i
      const canvasX = xToCancasX(CHART_BAR_WIDTH * i)
      const nextX = CHART_BAR_WIDTH * (i + 1)
      const barWidth = (xToCancasX(nextX) - canvasX) / 2
      let y = 0
      const yList = []
      for (const category in data[i]) {
        if (category !== 'year' && category !== '合計') {
          ctx.beginPath()
          const canvasY = yToCanvasY(y)
          const categoryY = data[i][category]
          const categoryHeight = yToCanvasY(y + categoryY) - canvasY
          ctx.rect(canvasX, canvasY, barWidth, categoryHeight)
          ctx.fillStyle = CATEGORY_COLOR[category]
          ctx.fill()
          yList.push({
            category,
            start: y,
            end: y + categoryY
          })
          y += categoryY
        }
      }
      currentChartData.push({
        x: {
          year: data[i]['year'],
          start: x,
          end: canvasXToX(canvasX + barWidth),
        },
        y: yList,
      })

      // X軸の目盛りを描画
      ctx.font = '12px Arial'
      ctx.fillStyle = '#000'
      ctx.textAlign = 'center'
      const graphScalePos = {
        x: canvasX + barWidth / 2,
        y: MARGIN_TOP + FRAME_HEIGHT + 15
      }
      ctx.fillText(`${data[i]['year']}`, graphScalePos.x, graphScalePos.y)
    }

    // はみ出た分を塗りつぶす
    ctx.beginPath()
    ctx.rect(MARGIN_LEFT + FRAME_WIDTH, MARGIN_TOP, MARGIN_RIGHT, FRAME_HEIGHT + MARGIN_BOTTOM)
    ctx.rect(0, 0, MARGIN_LEFT, CANVAS_HEIGHT)
    ctx.fillStyle = '#fff'
    ctx.fill()

    // Y軸の目盛りを描画
    for (let i = 1; i <= yGridCount; i++) {
      ctx.font = '12px Arial'
      ctx.fillStyle = '#000'
      ctx.textAlign = 'right'
      const y = i * yLimit / yGridCount
      const yGraphScaleText = getYWithUnitText(y)
      const canvasX = MARGIN_LEFT
      const canvasY = yToCanvasY(y)
      ctx.fillText(yGraphScaleText, canvasX - 15, canvasY)
    }

    // グラフのタイトルを描画
    ctx.font = '16px Arial'
    ctx.fillStyle = '#000'
    ctx.textAlign = 'center'
    ctx.fillText('一般会計歳出目的別歳出額', CANVAS_WIDTH / 2, MARGIN_TOP - 20)
  }

  async function init() {
    const json = await fetch('data.json').then((res) => res.json())
    const data = json.data
    const canvas = document.getElementById('barChart')
    canvas.width = CANVAS_WIDTH
    canvas.height = CANVAS_HEIGHT
    const ctx = canvas.getContext('2d')

    canvas.addEventListener("mousedown", function(e) {
    mouseDown = true
    })
    canvas.addEventListener("mouseup", function(e) {
      mouseDown = false
    })
    canvas.addEventListener("mousemove", function(e) {
      if (mouseDown) {
        newOffsetX = e.offsetX - mousePosX + offsetX
        offsetX = newOffsetX
        drawBarChart(data)
      }
      mousePosX = e.offsetX
      const x = canvasXToX(mousePosX)
      const hoveredBarData = currentChartData.find((item) => {
        return x >= item.x.start && x <= item.x.end
      })
      document.getElementById("x").innerHTML = `x: ${hoveredBarData ? hoveredBarData.x.year : 'なし'}`
      const y = canvasYToY(e.offsetY)
      const hoveredYData = hoveredBarData?.y?.find((item) => {
        return y >= item.start && y <= item.end
      })
      document.getElementById("y").innerHTML = `x: ${hoveredYData?.category ?? 'なし'}`
    })

    canvas.addEventListener("wheel", function(e) {
      let newScaleX = scaleX
      if (e.deltaY > 0) {
        newScaleX -= 0.1
      } else {
        newScaleX += 0.1
      }
      const newOffsetX = (1/newScaleX - 1/scaleX) * mousePosX + offsetX
      offsetX = newOffsetX
      scaleX = newScaleX
      drawBarChart(data)
    })
    
    drawBarChart(data)
    
  }
</script>

<body onload="init()">
  <canvas id="barChart"></canvas>
  <div>
    <div id="x">x: </div>
    <div id="y">y: </div>
  </div>
  
</body> 

</html>